{"version":3,"file":"graphql-codegen-pydantic.cjs.production.min.js","sources":["../src/visitor.ts","../src/index.ts"],"sourcesContent":["/* eslint-disable lines-between-class-members */\n/* eslint-disable class-methods-use-this */\n/* eslint-disable react/no-this-in-sfc */\nimport {\n  BaseVisitor,\n  ParsedConfig,\n  buildScalars,\n  indent,\n} from '@graphql-codegen/visitor-plugin-common';\nimport {\n  NamedTypeNode,\n  ListTypeNode,\n  NonNullTypeNode,\n  GraphQLSchema,\n  FieldDefinitionNode,\n  ObjectTypeDefinitionNode,\n  NameNode,\n  UnionTypeDefinitionNode,\n  DocumentNode,\n  InterfaceTypeDefinitionNode,\n  EnumTypeDefinitionNode,\n  InputObjectTypeDefinitionNode,\n  InputValueDefinitionNode,\n} from 'graphql';\nimport { snakeCase } from 'change-case';\nimport { DepGraph } from 'dependency-graph';\n\nimport { PydanticPluginRawConfig } from './config';\n\n\nexport const PYTHON_SCALARS = {\n  ID: 'str',\n  String: 'str',\n  Boolean: 'bool',\n  Int: 'int',\n  Float: 'float',\n  AWSDateTime: 'datetime',\n};\n\nconst PYTHON_RESERVED = ['from'];\nconst PYDANTIC_MODEL_RESERVED = ['copy'];\nconst RESERVED = PYTHON_RESERVED.concat(PYDANTIC_MODEL_RESERVED);\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface PydanticPluginParsedConfig extends ParsedConfig {\n  /* intentionally empty for now */\n  omitFields: string[]\n}\n\nexport class PydanticVisitor extends BaseVisitor<\n  PydanticPluginRawConfig,\n  PydanticPluginParsedConfig\n> {\n  private addOptionalImport = false;\n  private addAnyImport = false;\n  private addListImport = false;\n  private addUnionImport = false;\n  private addEnumImport = false;\n  private addFieldImport = false;\n  private addDatetimeImport = false;\n\n  private graph = new DepGraph({\n    circular: false,\n  });\n\n  constructor(\n    rawConfig: PydanticPluginRawConfig,\n    private schema: GraphQLSchema,\n  ) {\n    super(rawConfig, {\n      // enumValues: rawConfig.enumValues || {},\n      // listType: rawConfig.listType || 'List',\n      // package: rawConfig.package || defaultPackageName,\n      scalars: buildScalars(schema, {}, PYTHON_SCALARS),\n      omitFields: rawConfig.omitFields\n    });\n  }\n\n  public getImports(): string {\n    const typing = [];\n    const pydantic = ['BaseModel'];\n    const datetime = [];\n\n    if (this.addAnyImport) {\n      typing.push(`Any`);\n    }\n\n    if (this.addOptionalImport) {\n      typing.push(`Optional`);\n    }\n\n    if (this.addListImport) {\n      typing.push(`List`);\n    }\n\n    if (this.addUnionImport) {\n      typing.push(`Union`);\n    }\n\n    if (this.addFieldImport) {\n      pydantic.push(`Field`);\n    }\n\n    if (this.addDatetimeImport) {\n      datetime.push(`datetime`);\n    }\n\n    const enumInput = this.addEnumImport ? 'from enum import Enum' : '';\n\n    const typingImport = typing.length\n      ? `from typing import ${typing.join(', ')}`\n      : '';\n\n    const pydanticImport = pydantic.length\n      ? `from pydantic import ${pydantic.join(', ')}`\n      : '';\n\n    const datetimeImport = datetime.length\n        ? `from datetime import ${datetime.join(', ')}`\n        : '';\n\n    return [enumInput, typingImport, pydanticImport, datetimeImport].filter(i => i).join('\\n');\n  }\n\n  protected canAddGraphNode(id: string): boolean {\n    if (Object.values(this.scalars).includes(id) || id === 'Any') {\n      return false;\n    }\n\n    return true;\n  }\n\n  protected upsertGraphNode(id: string) {\n    if (this.canAddGraphNode(id) && !this.graph.hasNode(id)) {\n      this.graph.addNode(id);\n    }\n  }\n\n  protected addGraphNodeDeps(id: string, ids: string[]) {\n    if (!this.canAddGraphNode(id)) {\n      return;\n    }\n\n    this.upsertGraphNode(id);\n\n    ids.forEach((i: string) => {\n      if (!this.canAddGraphNode(i)) {\n        return;\n      }\n\n      this.upsertGraphNode(i);\n\n      this.graph.addDependency(id, i);\n    });\n  }\n\n  protected clearOptional(str: string): string {\n    if (str.startsWith('Optional[')) {\n      return str.replace(/Optional\\[(.*?)\\]$/, '$1');\n    }\n\n    return str;\n  }\n\n  Name(node: NameNode) {\n    return node.value;\n  }\n\n  NamedType(node: NamedTypeNode) {\n    const { name } = node as any;\n\n    // Scalars\n    if (Object.keys(this.scalars).includes(name)) {\n      const id = this.scalars[name];\n\n      if (id === 'datetime') {\n        this.addDatetimeImport = true;\n      }\n\n      // Special case for any\n      if (id === 'any') {\n        this.addAnyImport = true;\n        return {\n          id: 'Any',\n          source: 'Any',\n        };\n      }\n\n      this.addOptionalImport = true;\n      return {\n        id,\n        source: `Optional[${id}]`,\n      };\n    }\n\n    // Defined\n    this.addOptionalImport = true;\n    return {\n      id: name,\n      source: `Optional[\"${name}\"]`,\n    };\n  }\n\n  ListType(node: ListTypeNode) {\n    this.addListImport = true;\n    this.addOptionalImport = true;\n\n    const { type } = node as any;\n\n    return {\n      id: type.id,\n      source: `Optional[List[${type.source}]]`,\n    };\n  }\n\n  NonNullType(node: NonNullTypeNode) {\n    const { type } = node as any;\n\n    return {\n      id: type.id,\n      source: this.clearOptional(type.source),\n    };\n  }\n\n  protected visitFieldOrInputDefinition(node: any) {\n    const argName = node.name as any;\n\n    const { type, directives } = node as any;\n\n    // @todo handle de-duplicating if snakeCase will break\n    // eg aaaa and AAAA field\n\n    // Handle deprecated\n    const ds = directives.map((d: any) => d.name);\n    if (ds.includes('deprecated')) {\n      return null;\n    }\n\n    // Need to alias some field names\n    // Otherwise pydantic throws\n    if (RESERVED.includes(argName)) {\n      this.addFieldImport = true;\n      return {\n        id: type.id,\n        source: indent(\n          `${argName}_: ${type.source} = Field(None, alias=\"${argName}\")`,\n          2,\n        ),\n      };\n    }\n\n    return {\n      id: type.id,\n      source: indent(`${argName}: ${type.source}`, 2),\n    };\n  }\n\n  FieldDefinition(node: FieldDefinitionNode) {\n    return this.visitFieldOrInputDefinition(node);\n  }\n\n  InputValueDefinition(node: InputValueDefinitionNode) {\n    return this.visitFieldOrInputDefinition(node);\n  }\n\n  EnumTypeDefinition(node: EnumTypeDefinitionNode) {\n    this.addEnumImport = true;\n\n    const { name, values } = node as any;\n\n    const val = values\n      .map((v: any) => indent(`${v.name} = \"${v.name}\"`, 2))\n      .join('\\n');\n    const source = `class ${name}(str, Enum):\\n${val}`;\n\n    this.upsertGraphNode(name);\n\n    return {\n      id: name,\n      source,\n    };\n  }\n\n  UnionTypeDefinition(node: UnionTypeDefinitionNode) {\n    this.addUnionImport = true;\n\n    const { name, types } = node as any;\n\n    const unionTypes = (types ?? []).map((t: any) =>\n      this.clearOptional(t.source),\n    );\n\n    this.addGraphNodeDeps(\n      name,\n      types.map((t: any) => t.id),\n    );\n\n    return {\n      id: name,\n      source: `${name} = Union[${unionTypes.join(', ')}]`,\n    };\n  }\n\n  InterfaceTypeDefinition(node: InterfaceTypeDefinitionNode) {\n    const { name, fields: rawFields } = node as any;\n\n    const fields = rawFields.filter((f: any) => f);\n\n    const args = fields.map((f: any) => f.source).join('\\n');\n    const source = `class ${name}(BaseModel):\\n${args}`;\n\n    this.addGraphNodeDeps(\n      name,\n      fields.map((f: any) => f.id),\n    );\n\n    return {\n      id: name,\n      source,\n    };\n  }\n\n  ObjectTypeDefinition(node: ObjectTypeDefinitionNode) {\n    const { name, fields: rawFields, interfaces: rawInterfaces } = node as any;\n\n    rawFields.push({id: \"int\", source: indent(\"_version: int\", 2)})\n    let fields = rawFields.filter((f: any) => f)\n    if (this.config.omitFields) {\n      fields = fields.filter((f: any) => {\n        return this.config.omitFields.reduce((allow, key) => {\n          return allow && !f.source.startsWith(`    ${key}:`)\n        }, true)\n      });\n    }\n    \n    const interfaces = rawInterfaces.map((n: any) =>\n      this.clearOptional(n.source).replace(/'/g, ''),\n    );\n\n    const impl = interfaces.length ? interfaces.join(', ') : 'BaseModel';\n\n    const args = fields.map((f: any) => f.source).join('\\n');\n    const methods = indent(\"def __str__(self):\", 2)\n        + \"\\n\"\n        + indent(\"return self.value\", 4);\n    const source = `class ${name}(${impl}):\\n${args}\\n\\n${methods}`;\n\n    if (interfaces.length) {\n      this.addGraphNodeDeps(name, interfaces);\n    } else {\n      this.upsertGraphNode(name);\n    }\n\n    return {\n      id: name,\n      source,\n    };\n  }\n\n  InputObjectTypeDefinition(node: InputObjectTypeDefinitionNode) {\n    const { name, fields: rawFields } = node as any;\n\n    const fields = rawFields.filter((f: any) => f);\n\n    const args = fields.map((f: any) => f.source).join('\\n');\n    const source = `class ${name}(BaseModel):\\n${args}`;\n\n    this.upsertGraphNode(name);\n\n    return {\n      id: name,\n      source,\n    };\n  }\n\n  Document(node: DocumentNode) {\n    const { definitions } = node as any;\n\n    const nodesInOrder = this.graph.overallOrder();\n\n    return nodesInOrder\n      .map((n: any) => definitions.find((d: any) => d.id === n)?.source || '')\n      .join('\\n\\n\\n');\n  }\n}\n","import { PluginFunction, Types } from '@graphql-codegen/plugin-helpers';\nimport { GraphQLSchema, parse, printSchema, visit } from 'graphql';\nimport { PydanticPluginRawConfig } from './config';\nimport { PydanticVisitor } from './visitor';\n\n\n// eslint-disable-next-line import/prefer-default-export\nexport const plugin: PluginFunction<PydanticPluginRawConfig> = async (\n  schema: GraphQLSchema,\n  documents: Types.DocumentFile[],\n  config: PydanticPluginRawConfig,\n  info,\n): Promise<string> => {\n  const visitor = new PydanticVisitor(config, schema);\n  const printedSchema = printSchema(schema);\n  const astNode = parse(printedSchema);\n\n  const visitorResult = visit(astNode, { leave: visitor as any });\n  const imports = visitor.getImports();\n\n  return `${imports}\\n\\n\\n${visitorResult}\\n`;\n};\n"],"names":["PYTHON_SCALARS","ID","String","Boolean","Int","Float","AWSDateTime","RESERVED","concat","PydanticVisitor","BaseVisitor","constructor","rawConfig","schema","scalars","buildScalars","omitFields","DepGraph","circular","getImports","typing","pydantic","datetime","this","addAnyImport","push","addOptionalImport","addListImport","addUnionImport","addFieldImport","addDatetimeImport","addEnumImport","length","join","filter","i","canAddGraphNode","id","Object","values","includes","upsertGraphNode","graph","hasNode","addNode","addGraphNodeDeps","ids","forEach","addDependency","clearOptional","str","startsWith","replace","Name","node","value","NamedType","name","keys","source","ListType","type","NonNullType","visitFieldOrInputDefinition","argName","directives","map","d","indent","FieldDefinition","InputValueDefinition","EnumTypeDefinition","v","UnionTypeDefinition","types","unionTypes","t","InterfaceTypeDefinition","fields","rawFields","f","ObjectTypeDefinition","interfaces","rawInterfaces","config","reduce","allow","key","n","InputObjectTypeDefinition","Document","definitions","overallOrder","find","documents","info","visitor","printedSchema","printSchema","astNode","parse","visitorResult","visit","leave","imports"],"mappings":"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"}